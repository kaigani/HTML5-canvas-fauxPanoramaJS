// 
// FauxPanorama.js - Intro
//
// GLOBAL methods & variables
window.desktop=!1;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();window.version=1;(function(e){var t=function(){var e=this,t=[],n=0,r={};this.callback=function(){};this.add=function(e,r){t.push({id:e,src:r});n++};this.load=function(){console.log("Loading ["+t.length+"] "+n+" images.");for(var e=0;e<t.length;e++){var s=t[e],o=new Image;o.onload=i;o.src=s.src;r[s.id]=o}};var i=function(){n--;n===0&&e.callback.call()};this.callback=function(){console.log("No preloader callback defined.")};this.getById=function(e){return r[e]}},n=function(){var t=this;this.isPaused=!1;this.isLandscape=!0;this.tiltLR=0;this.tiltFB=0;this.direction=0;this.pitch=0;this.roll=0;this.callback=null;var n=function(n){if(!n.alpha){console.log("Device orientation not fully supported.");e.desktop=!0;t.pause();return}t.tiltLR=n.gamma;t.tiltFB=n.beta;t.direction=360-n.alpha;t.isLandscape=e.innerWidth>e.innerHeight;t.pitch=t.isLandscape?Math.abs(n.gamma):Math.abs(n.beta);t.roll=t.isLandscape?-1*n.beta:n.gamma;t.pitch=180-t.pitch;t.callback&&t.callback.call()};e.DeviceOrientationEvent?e.addEventListener("deviceorientation",n,!1):console.log("Device orientation not supported in this browser.");this.pause=function(){console.log("Device paused.");this.isPaused=!0;e.removeEventListener("deviceorientation",n,!1)};this.start=function(){console.log("Device started.");this.isPaused=!1;e.addEventListener("deviceorientation",n,!1)}},r=function(){this.x=0;this.y=0;this.w=0;this.h=0;this.setRect=function(e,t,n,r){this.x=e;this.y=t;this.w=n;this.h=r}},i=function(){this.rotation=0;this.pitch=90;this.cameraBounds=new r;this.cameraBounds.setRect(0,0,320,240);this.backgroundBounds=new r;this.backgroundBounds.setRect(0,0,640,480);this.leftBounds=new r;this.rightBounds=new r;this.isWraparound=!1;s(this)};i.prototype.rotateBy=function(e,t){this.rotation+=e;this.pitch+=t;this.rotation>359?this.rotation-=360:this.rotation<0&&(this.rotation+=360);this.pitch>180?this.pitch=180:this.pitch<0&&(this.pitch=0);s(this)};i.prototype.update=function(){s(this)};var s=function(e){var t=e.backgroundBounds.w/360,n=(e.backgroundBounds.h-e.cameraBounds.h)/180,r=1,i=e.rotation*t,s=e.pitch*n,o=Math.floor(i-.5*e.cameraBounds.w*r),u=o+e.cameraBounds.w*r,a=Math.floor(s);if(o<0){e.leftBounds.x=e.backgroundBounds.w+o;e.leftBounds.w=Math.abs(o);e.rightBounds.x=0;e.rightBounds.w=u;e.isWraparound=!0}else if(o>=0&&u<=e.backgroundBounds.w){e.leftBounds.x=o;e.leftBounds.w=u-o;e.rightBounds.w=0;e.isWraparound=!1}else if(o>=0&&u>e.backgroundBounds.w){e.leftBounds.x=o;e.leftBounds.w=e.backgroundBounds.w-o;e.rightBounds.x=0;e.rightBounds.w=u-e.backgroundBounds.w;e.isWraparound=!0}else{console.error("ERROR - Left/Right edges fall out of bounds!");console.log("Left edge: "+o+", Right Edge: "+u)}a<0?console.log("Upper:"+a+","+s+","+n+","+e.pitch):a>e.backgroundBounds.h-e.cameraBounds.h&&(a=e.backgroundBounds.h-e.cameraBounds.h);e.backgroundBounds.x=0-e.leftBounds.x;e.backgroundBounds.y=0-a};i.prototype.rotationToXOffset=function(){var e=this.backgroundBounds.w/360;return this.rotation*e*-1};var o=function(r){var s=this,o=this.viewport=new i,u=this.device=new n,a=this.preloader=new t,f=this.canvas=document.getElementById(r);this.invertX=!1;this.invertY=!1;this.speedX=2;this.speedY=4;var l=e.console;u.callback=function(){o.rotation=u.direction?u.direction:o.rotation;o.pitch=u.pitch};var c,h,p=function(e){c=e.clientX;h=e.clientY;f.addEventListener("mousemove",d,!1);f.addEventListener("touchmove",d,!1);u.isPaused||u.pause()},d=function(e){var t=e.hasOwnProperty("changedTouches")?e.changedTouches[0]:e,n=t.clientX-c,r=t.clientY-h;c=t.clientX;h=t.clientY;var i=0,u=0;n>0?i=s.speedX:n<0&&(i=-1*s.speedX);r>0?u=s.speedY:r<0&&(u=-1*s.speedY);s.invertX&&(i*=-1);s.invertY&&(u*=-1);o.rotateBy(i,u);s.update()},v=function(e){f.removeEventListener("mousemove",d,!1);f.removeEventListener("touchmove",d,!1)},m=function(){o.cameraBounds.w=f.width;o.cameraBounds.h=f.height;s.update()};e.addEventListener("resize",m,!1);f.addEventListener("mousedown",p,!1);f.addEventListener("mouseup",v,!1);f.addEventListener("touchstart",p,!1);f.addEventListener("touchend",v,!1)};o.prototype.start=function(){var t=this,n=e.console,r=new Event("FP:tick");if(!this.timer){n.log("Starting interval loop...");this.timer=setInterval(function(){t.update();e.dispatchEvent(r)},30)}this.update()};o.prototype.update=function(){var t=e.console,n=this.canvas,r=n.getContext("2d"),i=this.viewport;i.update();var s=this.preloader;this.count=this.count?this.count:0;this.timestamp=this.timestamp?this.timestamp:Date.now();var o=Date.now(),u=Math.floor(1e3/(o-this.timestamp));this.timestamp=o;this.count++;var a="";r.clearRect(0,0,n.width,n.height);var f=i.backgroundBounds.x,l=i.backgroundBounds.w%8===0?i.backgroundBounds.w/8:Math.floor(i.backgroundBounds.w/8)+1,c=Math.abs(l*8-i.backgroundBounds.w),h,p;r.fillStyle="rgb(255,0,0)";r.fillRect(i.backgroundBounds.x,i.backgroundBounds.y,i.backgroundBounds.w,i.backgroundBounds.h);for(var d=0;d<8;d++){if(f+l>=0&&f<i.cameraBounds.w){p="slice-0"+(d+1);h=s.getById(p);h||t.error("NO IMAGE FOUND: "+p);r.drawImage(h,f,i.backgroundBounds.y,l,i.backgroundBounds.h)}f+=l}if(i.isWraparound){f=i.leftBounds.w+c;r.fillStyle="rgb(0,0,255)";r.fillRect(f,i.backgroundBounds.y,i.backgroundBounds.w,i.backgroundBounds.h);for(d=0;d<8;d++){if(f+l>=0&&f<i.cameraBounds.w){p="slice-0"+(d+1);h=s.getById(p);h||t.error("NO IMAGE FOUND: "+p);r.drawImage(h,f,i.backgroundBounds.y,l,i.backgroundBounds.h)}f+=l}}};e.FauxPanorama=o})(window);